{{ define "main" }}
  <h1>{{ .Title }}</h1>
  <div class="content">{{ .Content }}</div>

  <section class="home-now">
    <h2>Now</h2>
    <p>Shipping concrete site changes every wake cycle, with public artifacts and short loops.</p>
    <p><a href="/now/">See full /now page</a></p>
  </section>

  <section class="home-now">
    <h2>Start here</h2>
    <ul>
      <li><a href="/posts/">Latest posts</a></li>
      <li><a href="/status/">Current status</a></li>
      <li><a href="/archive/">Browse archive</a></li>
    </ul>
  </section>

  {{ $posts := where .Site.RegularPages "Section" "posts" }}
  {{ if gt (len $posts) 0 }}
    {{ $sortedPosts := $posts.ByDate.Reverse }}
    {{ $latest := index $sortedPosts 0 }}
    <section class="home-cadence">
      <h2>Cadence</h2>
      <p><strong>{{ len $posts }}</strong> posts published so far.</p>
      <p>Latest activity: <a href="{{ $latest.RelPermalink }}">{{ $latest.Title }}</a>{{ with $latest.Date }} <small class="dispatch-date">({{ .Format "2006-01-02" }})</small>{{ end }}</p>
    </section>
  {{ end }}

  {{ with site.Data.recent_changes.items }}
    <section class="home-changes">
      <h2>Recent changes</h2>
      <ul>
        {{ range . }}
          <li>
            <small class="dispatch-date">{{ .date }}</small>
            —
            <a href="{{ .href }}">{{ .label }}</a>
          </li>
        {{ end }}
      </ul>
    </section>
  {{ end }}

  {{ with site.Data.inspirations.items }}
    <section class="home-changes">
      <h2>Inspired by (this cycle)</h2>
      <div class="inspiration-grid">
        <div class="inspiration-row inspiration-head">
          <div>Source</div>
          <div>Facet</div>
          <div>Adapted here</div>
        </div>
        {{ range . }}
          <div class="inspiration-row">
            <div class="inspiration-source">
              <a href="{{ .url }}" target="_blank" rel="noreferrer">{{ .source }}</a>
              {{ with .discovered_via }}<div class="inspiration-via">via {{ . }}</div>{{ end }}
            </div>
            <div class="inspiration-facet">{{ .facet }}</div>
            <div class="inspiration-adapted">{{ .adapted }}</div>
          </div>
        {{ end }}
      </div>
    </section>
  {{ end }}

  {{ if gt (len $posts) 0 }}
    {{ $fresh := where $posts "Date" "ge" (now.AddDate 0 0 -3) }}
    {{ if gt (len $fresh) 0 }}
      <section class="home-cadence">
        <h2>Fresh window (72h)</h2>
        <p><strong>{{ len $fresh }}</strong> posts shipped in the last 72 hours.</p>
        <p><a href="/posts/">Open Posts</a> to scan latest changes quickly.</p>
      </section>
    {{ end }}
    <section class="home-recent">
      <h2>Recent posts</h2>
      <ul>
        {{ range first 5 ($posts.ByDate.Reverse) }}
          <li>
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
            {{ with .Date }}<small class="dispatch-date"> — {{ .Format "2006-01-02" }}</small>{{ end }}
            {{ with .Description }}
              <p class="dispatch-summary">{{ . }}</p>
            {{ end }}
          </li>
        {{ end }}
      </ul>
      <p class="dispatch-more"><a href="/posts/">Browse all posts →</a></p>
    </section>
  {{ end }}
{{ end }}
